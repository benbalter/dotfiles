#!/bin/bash
# Set up all our dependencies
# Usage: script/setup

set -e

DOTFILES_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"
HOME_DIR="/Users/$USER"
source "$DOTFILES_ROOT/lib/functions.sh"
source "$DOTFILES_ROOT/lib/globals.sh"

if [ "$TRAVIS" != "true" ]; then
  sudo -v
else
  sudo -n -v
fi

title "Setting up home directory"
link_safe .gitconfig
link_safe .gitignore
link_safe .irbrc
link_safe .Brewfile
link_safe .gemrc

mkdir_safe "Library/LaunchAgents/"
link_safe Library/LaunchAgents/com.balter.ben.tmpreaper.plist
link_safe Library/LaunchAgents/com.balter.ben.update.plist

mkdir_safe projects
mkdir_safe github
mkdir_safe .ssh

if [[ ! -f "$HOME_DIR/.token" ]]; then
  echo "Create a GitHub Personal Access Token with *public* scope"
  echo "by going to https://github.com/settings/tokens"
  echo "and enter it below:"

  if [ "$TRAVIS" != "true" ]; then
    read token
  else
    token=""
  fi

  echo "$token" > "$HOME_DIR/.token"
fi

if ! type "brew" > /dev/null; then
  echo "Please run strap first. https://github.com/mikemcquaid/strap"
  exit 1
fi

title "Setting up Ruby"

if ! type "rbenv" > /dev/null; then
  brew install rbenv
  eval "$(rbenv init -)"
fi

if [ $(rbenv global) = "system" ]; then
  brew install ruby-build
  rbenv install $(latest_ruby)
  rbenv global $(latest_ruby)
  rbenv rehash
fi

if ! type "bundle" > /dev/null; then
  gem install bundler
fi

mkdir_safe .bundle
link_safe .bundle/config
source "$DOTFILES_ROOT/lib/ruby.sh"

title "Setting up Homebrew"
if ! brew bundle check --global; then
  brew bundle install --global
fi

title "Configuring OS X"
source "$DOTFILES_ROOT/lib/osx.sh"

if [ -d "$HOME_DIR/Dropbox/Desktop" ] && [ ! -L "$HOME_DIR/Dropbox/Desktop" ]; then
  title "Setting up dropbox"
  if [ "$(ls -A $HOME_DIR/Dropbox/Desktop)" ]; then
    cp "$HOME_DIR/Dropbox/Desktop/*" "$HOME_DIR/Desktop"
  fi
  rm -Rf "$HOME_DIR/Dropbox/Desktop/"
  ln -s "$HOME_DIR/Desktop" "$HOME_DIR/Dropbox/Desktop"
fi

title "Setting up the dock"
source "$DOTFILES_ROOT/lib/dock.sh"

title "Setting up Atom"
mkdir_safe .atom
link_safe .atom/config.cson
apm install --packages-file "$DOTFILES_ROOT/.atom/packages.txt"

title "Setting up NPM globals"
source "$DOTFILES_ROOT/lib/npm.sh"

title "Opening background apps"
source "$DOTFILES_ROOT/lib/first-start.sh"

if [ ! -d ~/.oh-my-zsh ] && [ "$TRAVIS" != "true" ]; then
  title "Setting up zsh"
  brew install wget
  sh -c "$(wget https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)"

  # Remove default .zshrc file so we can link_safe our own
  rm -f ~/.zshrc
  link_safe .zshrc

  # Set ZSH as the default shell
  command -v zsh | sudo -n tee -a /etc/shells
  sudo -n chsh -s "$(command -v zsh)" "${USER}"
  export SHELL=$(which zsh)

  # Iterm shell integration
  curl -L https://iterm2.com/misc/`basename $SHELL`_startup.in >> \
  ~/.iterm2_shell_integration.`basename $SHELL`
fi

title "Setting up Chrome"
ruby lib/chrome.rb

title "Setting up iTerm"
ruby lib/iterm.rb

title "Installing App Store apps"
source "$DOTFILES_ROOT/lib/app-store.sh"

title "Setting up Prey"
source "$DOTFILES_ROOT/lib/prey.sh"

# Remove strap.sh, which contains tokens
rm -f "$HOME_DIR/Downloads/strap.sh"

title "Fin."
